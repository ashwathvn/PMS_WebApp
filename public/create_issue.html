<!DOCTYPE html>
<html>
  <head>
    <title>Bug Tracking Tool</title>
    <link rel="stylesheet" href="style1.css" />
  </head>
  <body>
    <header>
      <h1 style="margin-left: 20px;">Bug Tracking Tool</h1>
    </header>
    <a href="home.html"><button>Back</button></a>
    <main>
      <section class="bug-list">
        <h2>Bugs</h2>
        <ul id="bugs-list"></ul>
      </section>
      <section class="bug-form">
        <h2>Add New Bug</h2>
        <form id="bug-form">
          <label for="bug-name">Title:</label>
          <input type="text" id="bug-name" name="bug-name" />
          <label for="bug-description">Description:</label>
          <textarea id="bug-description" name="bug-description"></textarea>
          <div class="dropdown">
            <label for="issue-type">Issue type:</label>
            <select id="issue-type" name="issue-type"></select>
          </div>
          <div class="dropdown">
            <label for="status-type">Status type:</label>
            <select id="status-type" name="status-type"></select>
          </div>
          <br /><br />
          <div class="dropdown">
            <label for="priority">Priority:</label>
            <select id="priority" name="priority">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="dropdown">
            <label for="severity">Severity:</label>
            <select id="severity" name="severity"></select>
          </div>
          <br /><br />
          <!-- <label for="bug-file">Upload File:</label>
          <input type="file" id="bug-file" name="bug-file"> -->
          <button type="submit" onclick="submitIssue()">Submit</button>
        </form>
      </section>
    </main>
    <div style="text-align: end; margin-right: 340px">
      <span id="err" style="color: red; font-weight: bolder"></span>
    </div>
    <footer></footer>
    <script>
      const issueTypeDropdown = document.getElementById("issue-type");
      const statusTypeDropdown = document.getElementById("status-type");
      const priorityDropdown = document.getElementById("priority");
      const severityDropdown = document.getElementById("severity");

      fetch("/allissues")
        .then((response) => response.json())
        .then((data) => {
          // Populate issue type dropdown
          issueTypeDropdown.innerHTML = "";
          const uniqueOptions = new Set();
          data.forEach((issueType) => {
            if (!uniqueOptions.has(issueType.issue)) {
              const option = document.createElement("option");
              option.value = issueType.issueid;
              option.text = issueType.issue;
              issueTypeDropdown.add(option);
              uniqueOptions.add(issueType.issue);
            }
          });
        })
        .catch((error) => console.error(error));

      // Populate status type dropdown
      fetch("/getallstatus")
        .then((response) => response.json())
        .then((data) => {
          statusTypeDropdown.innerHTML = "";
          const uniqueOptions = new Set();
          data.forEach((statusType) => {
            if (!uniqueOptions.has(statusType.status)) {
              const option = document.createElement("option");
              option.value = statusType.sid;
              option.text = statusType.status;
              statusTypeDropdown.add(option);
              uniqueOptions.add(statusType.status);
            }
          });
        })
        .catch((error) => console.error(error));

      // Populate priority dropdown
      // fetch('/issues')
      //   .then(response => response.json())
      //   .then(data => {
      //     priorityDropdown.innerHTML = '';
      //     const uniqueOptions = new Set();
      //     data.forEach(issues => {
      //       if (!uniqueOptions.has(issues.priority)) {
      //         const option = document.createElement('option');
      //         option.value = issues.priority;
      //         option.text = issues.priority;
      //         priorityDropdown.add(option);
      //         uniqueOptions.add(issues.priority);
      //       }
      //     });
      //   })
      //   .catch(error => console.error(error));

      // Populate severity dropdown
      fetch("/allseverities")
        .then((response) => response.json())
        .then((data) => {
          severityDropdown.innerHTML = "";
          const uniqueOptions = new Set();
          data.forEach((severity) => {
            if (!uniqueOptions.has(severity.severity)) {
              const option = document.createElement("option");
              option.value = severity.severityid;
              option.text = severity.severity;
              severityDropdown.add(option);
              uniqueOptions.add(severity.severity);
            }
          });
        })
        .catch((error) => console.error(error));

      function submitIssue() {
        var title = document.getElementById("bug-name").value;
        var desc = document.getElementById("bug-description").value;
        var issueType = document.getElementById("issue-type").value;
        var statusType = document.getElementById("status-type").value;
        var priority = document.getElementById("priority").value;
        var severity = document.getElementById("severity").value;

        if (!title) {
          document.getElementById("err").innerHTML = "Title is required";
        } else if (!desc) {
          document.getElementById("err").innerHTML = "Description is required";
        } else if (!issueType) {
          document.getElementById("err").innerHTML = "Issue Type is required";
        } else if (!statusType) {
          document.getElementById("err").innerHTML = "Status is required";
        } else if (!priority) {
          document.getElementById("err").innerHTML = "Priority is required";
        } else if (!severity) {
          document.getElementById("err").innerHTML = "Severity is required";
        } else {
          const issueData = {
            Title: title,
            description: desc,
            issueid: issueType,
            sid: statusType,
            priority: priority,
            severityid: severity,
            empid: 2,
            label: "CUSTOMER",
          };

          fetch("/createissue", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(issueData),
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              }
              throw new Error("Network response was not ok.");
            })
            .then((data) => {
              console.log("Response data", data);
              alert("Issue created successfully");
            })
            .catch((error) => {
              console.error(
                "There was a problem with the fetch operation:",
                error
              );
            });
        }
      }
    </script>
    <script src="script_new.js"></script>
  </body>
</html>
